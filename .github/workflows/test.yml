name: Test

on:
  push

jobs:
  push-acr:
    runs-on: ubuntu-latest
    services:
      verdaccio:
        image: verdaccio/verdaccio
        ports:
          - 4873:4873
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ssh-key: ${{ secrets.SUBMODULE_SSH_KEY }}
          submodules: true
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: network=host
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            nocobase/nocobase
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      - name: ssh deploy
        uses: appleboy/ssh-action@master
        env:
          IMAGE_TAG: ${{ steps.meta.outputs.tags }}
        with:
          host: ${{ secrets.deploy_host }}
          username: ${{ secrets.deploy_host_username }}
          password: ${{ secrets.deploy_host_password }}
          envs: IMAGE_TAG
          script: |
            export APP_NAME=$(echo $IMAGE_TAG | cut -d ":" -f 2)
            echo $APP_NAME
            echo "http://localhost:53000/up/$APP_NAME"
            curl "http://localhost:53000/up/$APP_NAME"
